function calcBounds(){bounds=null,layers.forEach(function(a){bounds?bounds.extend(a.layer.getBounds()):bounds=a.layer.getBounds()}),bounds&&map.fitBounds(bounds)}function pullChanges(){client.pullChanges(cursorTag,function(a,b){return a?showError(a):(cursorTag=b.cursorTag,void processChanges(b.changes))})}function processChanges(a){a.forEach(function(a){if(a.wasRemoved){for(console.log("Removed: "+a.path),i=0;i<layers.length;i++)if(layers[i].path==a.path){map.removeLayer(layers[i].layer),layers.splice(i,1),calcBounds();break}}else console.log(a.path),".gpx"==a.path.substr(-4)&&client.readFile(a.path,function(b,c){return b?showError(b):(layer=omnivore.gpx.parse(c),layer.addTo(map),layers.push({layer:layer,path:a.path}),void calcBounds())})}),interval=a.shouldBackOff?5e3:0,setTimeout(poll,interval)}function poll(){console.log("Polling for changes..."),client.pollForChanges(cursorTag,function(a,b){return a?showError(a):void(b.hasChanges?(console.log("Changes detected."),pullChanges()):(console.log("No changes detected."),setTimeout(poll,1e3*b.retryAfter)))})}function run(){console.log("running"),pullChanges()}function showError(a){console.log(a)}var client=new Dropbox.Client({key:"9a666eiuctz1yh4"}),cursorTag=null,layers=Array(),defaultCenter=L.latLng(39,-78),map=L.map("map").setView(defaultCenter,13);L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community"}).addTo(map),client.authenticate({interactive:!1},function(a,b){return a?showError(a):void(b.isAuthenticated()?run(b):b.authenticate(function(a,b){return a?showError(a):void run(b)}))});